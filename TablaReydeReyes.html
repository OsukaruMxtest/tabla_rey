<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificación</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        body {
            position: relative;
            background-image: url('https://i.imgur.com/f0txTlJ.png');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-width: 100vw;
            padding: 20px;
        }

        .contenedor-tablas {
            display: flex;
            width: 90%;
            height: 80%;
            justify-content: center;
            align-items: flex-start;
            padding-top: var(--top-inicial, 100px);
        }

        #contenedor-unico {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tabla-cuerpo {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: transparent !important;
            border: none !important;
            position: relative;
        }

        .tabla-cabecera {
            display: none !important;
        }

        .fila {
            display: flex;
            position: relative;
            opacity: 0;
            animation: fadeInRight 0.5s forwards;
            margin-bottom: var(--separacion-vertical, 0px);
            height: var(--altura-fila, 60px);
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .celda {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: absolute;
        }

        .posicion {
            font-weight: bold;
            font-size: 3.2rem;
            color: #FFD700;
            justify-content: center;
            left: var(--pos-x, 310px);
        }

        .jugador {
            font-weight: bold;
            font-size: 3.2rem;
            justify-content: flex-start;
            left: var(--jugador-x, 700px);
        }

        .puntos {
            font-weight: bold;
            font-size: 3.2rem;
            justify-content: center;
            left: var(--puntos-x, 1450px);
        }

        .navegacion {
            position: absolute;
            width: 300px;
            height: 200px;
            opacity: 0;
            cursor: pointer;
        }

        #atras {
            bottom: 100;
            left: 0;
        }

        #siguiente {
            bottom: 100;
            right: 0;
        }

        .pagina-indicador {
            display: none !important;
        }
        
        .tabla-cuerpo {
            min-height: 800px;
            overflow: visible !important;
        }

        #contenedor-unico {
            overflow: visible !important;
        }

        #viewport-1920 {
            width: 1920px;
            height: 1080px;
            transform-origin: top left;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="viewport-1920">
        <div id="contenedor-unico">
            <div class="tabla-cuerpo" id="cuerpo-unico">
            </div>
        </div>

        <div class="navegacion" id="atras"></div>
        <div class="navegacion" id="siguiente"></div>
    </div>

    <script>
        let jugadores = new Map(); 
        let datosOrdenados = [];
        let paginaActual = 1;
        let maxPaginas = 1; 

        const configPosiciones = {
            posX: "250px",      
            jugadorX: "700px", 
            puntosX: "1550px",   
            separacionVertical: "-75px", 
            alturaFila: "80px", 
            topInicial: "317px" 
        };

        function aplicarConfiguracion() {
            document.documentElement.style.setProperty('--pos-x', configPosiciones.posX);
            document.documentElement.style.setProperty('--jugador-x', configPosiciones.jugadorX);
            document.documentElement.style.setProperty('--puntos-x', configPosiciones.puntosX);
            document.documentElement.style.setProperty('--separacion-vertical', configPosiciones.separacionVertical);
            document.documentElement.style.setProperty('--altura-fila', configPosiciones.alturaFila);
            document.documentElement.style.setProperty('--top-inicial', configPosiciones.topInicial);
        }

        const puntosPosicion = {
            1: 10, 2: 6, 3: 5, 4: 4, 5: 3, 6: 2, 7: 1, 8: 1
        };

        async function cargarTodosCSV() {
            let indice = 1;
            let archivosCargados = 0;
            const maxIntentos = 50; 

            while (indice <= maxIntentos) {
                try {
                    const respuesta = await fetch(`data/campeon_supremo/partidas/M${indice}.csv`);
                    if (!respuesta.ok) {
                        break;
                    }
                    const texto = await respuesta.text();
                    procesarCSV(texto, indice);
                    archivosCargados++;
                    indice++;
                } catch (error) {
                    break;
                }
            }

            if (archivosCargados === 0) {
                console.error("No se encontraron archivos CSV. Usando datos de ejemplo.");
                datosDeEjemplo();
            }

            procesarYOrdenarJugadores();
            aplicarConfiguracion(); 
            renderizarPagina(paginaActual);
        }

        function procesarCSV(textoCSV, numeroPartida) {
            const lineas = textoCSV.split('\n').filter(linea => linea.trim() !== '');
            
            let inicio = 0;
            if (lineas[0].toLowerCase().includes('uid')) {
                inicio = 1;
            }

            for (let i = inicio; i < lineas.length; i++) {
                const columnas = lineas[i].split(',');
                if (columnas.length < 7) continue;

                const rango = parseInt(columnas[2]?.trim());
                const uId = columnas[3]?.trim();
                const nombre = columnas[4]?.trim() || `Jugador ${uId}`;
                const bajas = parseInt(columnas[6]?.trim()) || 0;

                if (!uId || isNaN(rango)) continue;

                if (!jugadores.has(uId)) {
                    jugadores.set(uId, {
                        nombre: nombre,
                        puntos: 0,
                        wwcd: 0, 
                        puntosPosicion: 0,
                        puntosBajas: 0,
                        mejorPosicionUltima: Infinity,
                        ultimaPartida: numeroPartida
                    });
                }

                const jugador = jugadores.get(uId);
                
                const puntosPorPos = puntosPosicion[rango] || 0;
                jugador.puntosPosicion += puntosPorPos;
                jugador.puntosBajas += bajas;
                jugador.puntos += puntosPorPos + bajas;
                
                if (rango === 1) {
                    jugador.wwcd += 1;
                }
                
                if (numeroPartida >= jugador.ultimaPartida) {
                    jugador.ultimaPartida = numeroPartida;
                    if (rango < jugador.mejorPosicionUltima) {
                        jugador.mejorPosicionUltima = rango;
                    }
                }
            }
        }

        function datosDeEjemplo() {
            const nombres = ['Alex', 'Berta', 'Carlos', 'Diana', 'Edu', 'Fátima', 'Gorka', 'Helena', 'Iván', 'Julia', 'Kevin', 'Luna', 'Mario', 'Nora', 'Óscar', 'Paula', 'Quique', 'Rosa', 'Sergio', 'Tania', 'Ulises', 'Vega', 'Wendy', 'Xavier', 'Yolanda', 'Zoe', 'Aitor', 'Bianca', 'César', 'Dámaris', 'Elena', 'Fernando', 'Gabriela', 'Héctor', 'Isabel', 'Javier', 'Karina', 'Luis', 'Marta', 'Nacho'];
            
            for (let i = 1; i <= 40; i++) {
                const uId = `ID${i}`;
                const nombre = nombres[i-1] || `Jugador ${i}`;
                const puntosBase = 100 - i * 2 + Math.floor(Math.random() * 20);
                const wwcd = Math.min(Math.floor(Math.random() * 5), Math.floor(i/5));
                
                jugadores.set(uId, {
                    nombre: nombre,
                    puntos: puntosBase + wwcd * 10,
                    wwcd: wwcd,
                    puntosPosicion: puntosBase * 0.7,
                    puntosBajas: puntosBase * 0.3,
                    mejorPosicionUltima: Math.min(8, Math.ceil(i/4)),
                    ultimaPartida: 3
                });
            }
        }

        function ordenarJugadores() {
            const arrayJugadores = Array.from(jugadores.entries()).map(([uId, datos]) => ({
                uId,
                ...datos
            }));

            arrayJugadores.sort((a, b) => {
                if (b.puntos !== a.puntos) return b.puntos - a.puntos;
                
                if (b.wwcd !== a.wwcd) return b.wwcd - a.wwcd;
                
                if (b.puntosPosicion !== a.puntosPosicion) return b.puntosPosicion - a.puntosPosicion;
                
                if (b.puntosBajas !== a.puntosBajas) return b.puntosBajas - a.puntosBajas;
                
                return a.mejorPosicionUltima - b.mejorPosicionUltima;
            });

            return arrayJugadores;
        }

        function procesarYOrdenarJugadores() {
            datosOrdenados = ordenarJugadores();
            maxPaginas = Math.ceil(datosOrdenados.length / 10);
        }

        function renderizarPagina(pagina) {
            if (pagina < 1 || pagina > maxPaginas) return;
            
            paginaActual = pagina;
            
            const cuerpo = document.getElementById('cuerpo-unico');
            cuerpo.style.height = "calc(100vh - 40px)"; 
            cuerpo.style.overflow = "visible";
            
            cuerpo.innerHTML = '';
            
            const inicio = (pagina - 1) * 10;
            
            for (let i = 0; i < 10; i++) {
                const indiceGlobal = inicio + i;
                const jugador = datosOrdenados[indiceGlobal];
                const posicionReal = indiceGlobal + 1;
                
                setTimeout(() => {
                    crearFila(jugador, posicionReal, cuerpo, i);
                }, i * 80); 
            }
            
            document.getElementById('siguiente').style.cursor = pagina < maxPaginas ? 'pointer' : 'default';
            document.getElementById('atras').style.cursor = pagina > 1 ? 'pointer' : 'default';
        }

        function crearFila(jugador, posicion, contenedor, indiceFila) {
            const fila = document.createElement('div');
            fila.className = 'fila';
            
            const topInicial = parseInt(configPosiciones.topInicial) || 240;
            const alturaFila = parseInt(configPosiciones.alturaFila) || 60;
            const topPosicion = topInicial + (indiceFila * alturaFila);
            fila.style.top = `${topPosicion}px`;
            
            const celdaPos = document.createElement('div');
            celdaPos.className = 'celda posicion';
            celdaPos.textContent = posicion;
            
            const celdaJugador = document.createElement('div');
            celdaJugador.className = 'celda jugador';
            celdaJugador.textContent = jugador ? jugador.nombre : '';
            celdaJugador.style.maxWidth = '700px';
            celdaJugador.style.overflow = 'hidden';
            celdaJugador.style.textOverflow = 'ellipsis';
            
            const celdaPuntos = document.createElement('div');
            celdaPuntos.className = 'celda puntos';
            celdaPuntos.textContent = jugador ? jugador.puntos : '';
            
            fila.appendChild(celdaPos);
            fila.appendChild(celdaJugador);
            fila.appendChild(celdaPuntos);
            contenedor.appendChild(fila);
        }

        document.getElementById('siguiente').addEventListener('click', () => {
            if (paginaActual < maxPaginas) {
                renderizarPagina(paginaActual + 1);
            }
        });

        document.getElementById('atras').addEventListener('click', () => {
            if (paginaActual > 1) {
                renderizarPagina(paginaActual - 1);
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            cargarTodosCSV();
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight' && paginaActual < maxPaginas) {
                    renderizarPagina(paginaActual + 1);
                } else if (e.key === 'ArrowLeft' && paginaActual > 1) {
                    renderizarPagina(paginaActual - 1);
                }
            });
        });

        window.configuracionPosiciones = configPosiciones;
        window.aplicarConfiguracion = aplicarConfiguracion;
        window.renderizarPagina = renderizarPagina;
    </script>
    <script>
        function ajustarViewport1920() {
            const baseWidth = 1920;
            const baseHeight = 1080;

            const scaleX = window.innerWidth / baseWidth;
            const scaleY = window.innerHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);

            const viewport = document.getElementById("viewport-1920");
            viewport.style.transform = `scale(${scale})`;

            const offsetX = (window.innerWidth - baseWidth * scale) / 2;
            const offsetY = (window.innerHeight - baseHeight * scale) / 2;

            viewport.style.marginLeft = offsetX + "px";
            viewport.style.marginTop = offsetY + "px";
        }

        window.addEventListener("resize", ajustarViewport1920);
        window.addEventListener("load", ajustarViewport1920);
    </script>
</body>
</html>
